<?
    // Set up page title:
    $this->headTitle($this->translate('My Holds'));

    // Set up breadcrumbs:
    $this->layout()->breadcrumbs = '<li><a href="' . $this->url('myresearch-home') . '">' . $this->transEsc('Your Account') . '</a> <span class="divider">&gt;</span></li>'
        . '<li class="active">' . $this->transEsc('My Holds') . '</li>';
?>

<div class="<?=$this->layoutClass('mainbody')?>">
  <h2><?=$this->transEsc('Your Holds and Recalls') ?></h2>

  <?=$this->flashmessages()?>

  <? $delay_note = "Note: If you just placed a hold it may take a minute to work its way through the system and show up here. E-ZBorrow holds will display when they have arrived at the Library." ?>

  <? if (!empty($this->recordList['ils_records'])): ?>
    <?=$delay_note ?>
    <? // trico edit 2014.04.23 ah - we don't have functionality for patrons 
    // to cancel holds. rather than editing that code to accommodate our
    // data structure i'm deleting it for now. ?>

    <? $iteration = 0; ?>
    <? /* TRICO edit 2013-03-27 sl - changed array processing to reflect the array of arrays generated by Innovative.php. 
       New array structure allows for display of ILL requests as well as TriCo holds.
       See getMyHolds function in Innovative.php and MyResearchController holdsAction
       for screen scraping rules and affected fields */ ?>
    <? foreach ($this->recordList['ils_records'] as $resource): ?>
      <? $iteration++; ?>
      <? $ilsDetails = $resource->getExtraDetail('ils_details'); ?>
      <div id="record<?=$this->escapeHtmlAttr($resource->getUniqueId()) ?>" class="result row-fluid">
        <div class="span2 text-center">
          <? if ($summThumb = $this->record($resource)->getThumbnail()): ?>
            <img src="<?=$this->escapeHtmlAttr($summThumb)?>" class="recordcover" alt="<?=$this->transEsc('Cover Image')?>"/>
          <? else: ?>
            <img src="<?=$this->url('cover-unavailable')?>" class="recordcover" alt="<?=$this->transEsc('No Cover Image')?>"/>
          <? endif; ?>
        </div>
        <div class="span9">
          <?
            // If this is a non-missing Solr record, we should display a link:
            if (is_a($resource, 'VuFind\\RecordDriver\\SolrDefault') && !is_a($resource, 'VuFind\\RecordDriver\\Missing')) {
              $title = $resource->getTitle();
              $title = empty($title) ? $this->transEsc('Title not available') : $this->escapeHtml($title);
              echo '<a href="' . $this->recordLink()->getUrl($resource)
                . '" class="title">' . $title . '</a>';
            } else if (isset($ilsDetails['title']) && !empty($ilsDetails['title'])){
              // If the record is not available in Solr, perhaps the ILS driver sent us a title we can show...
              echo $this->escapeHtml($ilsDetails['title']);
            } else {
              // Last resort -- indicate that no title could be found.
              echo $this->transEsc('Title not available');
            }
          ?><br/>
          <? if (isset($ilsDetails['volume']) && !empty($ilsDetails['volume'])): ?>
            <strong><?=$this->transEsc('Volume')?>:</strong> <?=$this->escapeHtml($ilsDetails['volume'])?>
            <br />
          <? endif; ?>
          <? $listAuthor = $resource->getPrimaryAuthor(); if (!empty($listAuthor)): ?>
            <?=$this->transEsc('by')?>:
            <a href="<?=$this->record($resource)->getLink('author', $listAuthor)?>"><?=$this->escapeHtml($listAuthor)?></a><br/>
          <? endif; ?>

          <? $formats = $resource->getFormats(); if (count($formats) > 0): ?>
            <?=$this->record($resource)->getFormatList()?>
            <br/>
          <? endif; ?>

          <? if (isset($ilsDetails['publication_year']) && !empty($ilsDetails['publication_year'])): ?>
            <strong><?=$this->transEsc('Year of Publication')?>:</strong> <?=$this->escapeHtml($ilsDetails['publication_year'])?>
            <br />
          <? endif; ?>

          <? if (!empty($ilsDetails['requestGroup'])): ?>
            <strong><?=$this->transEsc('hold_requested_group') ?>:</strong> <?=$this->transEsc('location_' . $ilsDetails['requestGroup'], array(), $ilsDetails['requestGroup'])?>
            <br />
          <? endif; ?>

          <? /* Depending on the ILS driver, the "location" value may be a string or an ID; figure out the best
             value to display... */ ?>
          <? $pickupDisplay = ''; ?>
          <? $pickupTranslate = false; ?>
          <? if (isset($ilsDetails['location'])): ?>
            <? if ($this->pickup): ?>
              <? foreach ($this->pickup as $library): ?>
                <? if ($library['locationID'] == $ilsDetails['location']): ?>
                  <? $pickupDisplay = $library['locationDisplay']; ?>
                  <? $pickupTranslate = true; ?>
                <? endif; ?>
              <? endforeach; ?>
            <? endif; ?>
            <? if (empty($pickupDisplay)): ?>
              <? $pickupDisplay = $ilsDetails['location']; ?>
            <? endif; ?>
          <? endif; ?>
          <? if (!empty($pickupDisplay)): ?>
            <strong><?=$this->transEsc('pick_up_location') ?>:</strong>
            <?=$pickupTranslate ? $this->transEsc($pickupDisplay) : $this->escapeHtml($pickupDisplay)?>
            <br />
          <? endif; ?>

          <? /* trico EDIT 2012-10-05 ah - don't have created and only have expires sometimes */ ?>
          <? if (!empty($ilsDetails['create'])): ?>
            <strong><?=$this->transEsc('Created') ?>:</strong> <?=$this->escapeHtml($ilsDetails['create']) ?><br />
          <? endif; ?>
          <? if (!empty($ilsDetails['expire'])): ?>
            <strong><?=$this->transEsc('Expires') ?>:</strong> <?=$this->escapeHtml($ilsDetails['expire']) ?><br />
            <? endif; ?>
          <? if (!empty($ilsDetails['status'])): ?>
            <strong>Item Status:</strong> <?=$this->escapeHtml($ilsDetails['status']) ?><br />
          <? endif; ?>

            <? if (isset($ilsDetails['available']) && $ilsDetails['available'] == true): ?>
              <div class="info"><?=$this->transEsc("hold_available") ?></div>
            <? elseif (isset($ilsDetails['position'])): ?>
              <p><strong><?=$this->transEsc("hold_queue_position") ?>:</strong> <?=$this->escapeHtml($ilsDetails['position']) ?></p>
            <? endif; ?>
            <? if (isset($ilsDetails['cancel_link'])): ?>
              <p><a href="<?=$this->escapeHtmlAttr($ilsDetails['cancel_link']) ?>"><?=$this->transEsc("hold_cancel") ?></a></p>
            <? endif; ?>

        </div>
      </div>
    <? endforeach; ?>
  <? else: ?>
    You do not have any holds. <?=$delay_note ?>
  <? endif; ?>

  <? /* TRICO edit 2013-03-28 sl - Code for displaying ILL request data 
     now scraped by Innovative.php and processed by Holds.php  */ ?>
  <br />
  <h2>Your Interlibrary Loan Requests</h2>
  <? if (!is_array($this->recordList['ill_records'])): ?>
    If you've made Interlibrary Loan requests, they will display here after they have been reviewed by ILL staff.
  <? else: ?>
    Interlibrary loan requests display here after they have been reviewed by ILL staff.
    <? $iteration = 0; ?>
    <? foreach ($this->recordList['ill_records'] as $illDetails): ?>
      <? $iteration++; ?>
      <div id="record" class="result row-fluid">
        <div class="span2 text-center">
          <? /* ILL requests are placed with dummy records lacking data like ISBN no need for bookcover code.
             We'll just add in the default image for layout consistency */ ?>
          <img src="<?=$this->url('cover-unavailable')?>" class="summcover" alt="<?=$this->transEsc('No Cover Image')?>"/>
        </div>
        <div class="span9">
          <? if (!empty($illDetails['title'])): ?>
            <?=$this->escapeHtml($illDetails['title']);?> <br />
          <? else: ?>
            <?=$this->transEsc('Title not available') ?> <br />
          <? endif; ?>
          <? if (!empty($illDetails['status'])): ?>
            <strong>Item Status:</strong> <?=$this->escapeHtml($illDetails['status']);?> <br />
          <? endif; ?>
          <? if (!empty($illDetails['location'])): ?>
            <strong>Pickup Location:</strong> <?=$this->escapeHtml($illDetails['location']);?> <br />
          <? endif; ?>
        </div>
      </div>
    <? endforeach; ?>
  <? endif; ?>
</div>

  <div class="<?=$this->layoutClass('sidebar')?>">
    <?=$this->context($this)->renderInContext("myresearch/menu.phtml", array('active' => 'holds'))?>
  </div>
